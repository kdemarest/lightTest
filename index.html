<html>
<head>
<link rel="stylesheet" type="text/css" href="minireset.css"/>
<style type="text/css">
	html, body{
		height: 100%;
		/*overflow: hidden;*/
	}
	body {
		color: rgb(220, 220, 220);
		background-color: black;
	}
	canvas#canvas {
		position: absolute;
		top: 0px;
		left: 0px;
	}
</style>
<title>Light Test</title>
<script src="jquery-3.3.1.js" charset="utf-8"></script>
<script src="entity.js" charset="utf-8"></script>
<script src="sprite.js" charset="utf-8"></script>
<script src="animation.js" charset="utf-8"></script>

<script>
// file:///Users/ken/code/lightTest/index.html

Array.prototype.filterInPlace = function(condition) {
	let i = 0, j = 0;
	let a = this;
	
	while (i < a.length) {
		const val = a[i];
		if (condition(val, i, a)) a[j++] = val;
		i++;
	}

	a.length = j;
	return a;
}

let FPS = 60;
let ImageSrc = {
	guy: 'cloakedBlue.png',
	floor: 'floor.jpg',
	potion: 'potion.png',
	lightLit: ['lanternLitSharp3.png', {across:5, down:1 }],
	sight: 'sight2.png',
	flicker0: 'flickerj0.png',
	flicker1: 'flickerj1.png',
	flicker2: 'flickerj2.png',
	flicker3: 'flickerj3.png',
	flicker4: 'flickerj4.png',
	flameSheet: ['5.png', { across: 5, down: 4 } ],
	explosion: ['Exp032purple.png', { across: 8, down: 8, dim: 128 } ],
};
// 4 is good, centered
// 6! has some falling debris, 10 with w:192,h:192 for big hit
// 11 is great
// 6a is purple. Use dir=-1
// 13 is a head shot
// 18 is a straight-on shot
// 26 is good reversed. pieces fly into the player nicely.
// 31a dir 1 looks best (or 32 purpled)
//let expIndex = 32;
//let expDim = expIndex <= 10 ? { across: 16, down: 4, dir: 1, dim: 192 } : { across: 8, down: 8, dir: 1, dim: 128 };
//let name = 'Exp0'+(expIndex<10?'0':'')+expIndex+'.png';
//ImageSrc['exp'+expIndex] = [ name, expDim ];


// Sight is Opactiy 40%, brush size 220, hardness 90
// Flames are from https://graphicriver.net/downloads

let Img = {};

function assetLoad(imageSrc, target) {
	return new Promise( (resolve,reject)=>{
		let imagesRequested = Object.keys(imageSrc).length;
		let imagesLoaded = 0;
		let gotImage = function() {
			if( ++imagesLoaded >= imagesRequested ) {
				resolve();
			}
		}
		for(let key in imageSrc){
			let isSheet = Array.isArray(imageSrc[key]);
			let image = new Image();
			image.onload = gotImage;
			image.src = isSheet ? imageSrc[key][0] : imageSrc[key];
			image.onInit = null;
			if( isSheet ) {
				console.assert( imageSrc[key][1].across );
				image.sheet = imageSrc[key][1];
			}
			target[key] = image;
		}
	});
}

function contextGet(id) {
	let c = document.getElementById(id).getContext('2d');
	return c;
}

function randInt(n) {
	return Math.floor(Math.random()*n);
}


function start(callback) {

	Animation.lightFlicker = function(light) {
		let instabilityDuration = 2;	// in seconds
		let maxStabilityDuration = 8;	// in seconds
		let flickerFrequency = 0.1;		// in seconds
		this.frames = ['flicker0','flicker1','flicker2','flicker3','flicker4'];
		this.stable = randInt(instabilityDuration+maxStabilityDuration);
		this.onTick = () => {
			this.stable -= 1/FPS;
			if( this.stable < instabilityDuration && randInt(100)<FPS*flickerFrequency ) {
				light.frameIndex = randInt(light.frameCount);
			}
			if( this.stable < 0 ) {
				this.stable = instabilityDuration+randInt(maxStabilityDuration);
			}
			let f = light.flicker;
			f.x = light.x;
			f.y = light.y;
			f.frameIndex = light.frameIndex;	// sync with the light
			f.img = Img[this.frames[f.frameIndex]];
		}
	}

	Animation.run = function(sprite,settings) {
		sprite.frameIndex = settings.direction < 0 ? sprite.frameCount : 0;
		this.onTick = () => {
			sprite.frameIndex += settings.direction || 1
			this.alive = sprite.frameIndex >= 0 && sprite.frameIndex < sprite.frameCount;
			sprite.alive = settings.spriteDieAtEnd ? this.alive : sprite.alive;
		}
	}

	Img.lightLit.onInit = function() {
		this.flicker = new Sprite( Img.flicker0, Phase.visibility );
		spriteList.push( this.flicker );
		this.onEnd = () => this.flicker.alive=false;
		animationList.push( new Animation( Animation.lightFlicker, this ) );
	}

	Img.explosion.onInit = function() {
		this.w = this.img.sheet.dim;
		this.h = this.img.sheet.dim;
		animationList.push( new Animation( Animation.run, this, { direction: 1, spriteDieAtEnd: true } ) );
	}


	let init = {
		sights:  [1,1],
		lights:  [2,5, 6,2, 7,3],
		potions: [2,2, 1,3, 5,4, 5,1],
		guys:    [2,0, 1,1, 3,3, 5,3, 2,4, 8,3]
	};

	function spritesCreate(img,phase,list) {
		let result = [];
		for( let i=0 ; i<list.length ; i+=2 ) {
			let sprite = new Sprite(img,phase);
			sprite.setPos( 32+list[i+0]*64, 32+list[i+1]*64 );
			result.push(sprite);
		}
		return result;
	}

	function initializeWorld() {
		for( let y=0 ; y<10 ; ++y ) {
			for( let x=0 ; x<10 ; ++x ) {
				spriteList.push( new Sprite( Img.floor, Phase.floors ).setPos( 32+x*64, 32+y*64 ) );
			}
		}
		spriteList.push( ...spritesCreate( Img.sight, Phase.visibility, init.sights ) );
		spriteList.push( ...spritesCreate( Img.lightLit, Phase.items, init.lights ) );
		spriteList.push( ...spritesCreate( Img.potion, Phase.items, init.potions ) );
		spriteList.push( ...spritesCreate( Img.guy, Phase.players, init.guys ) );

		let explosion = new Sprite( Img.explosion, Phase.explosions );
		explosion.setPos( 32+5*64, 32+20+3*64 );
		spriteList.push(explosion);

	}

	function render() {
		spriteList.render(ctx);
	}

	function tick() {
		animationList.tick()
		animationList.checkAlive();
		spriteList.checkAlive();
	}

	let ctx = contextGet('canvas');
	let spriteList = new SpriteList();
	let animationList = new AnimationList();
	initializeWorld();
	setInterval( () => {
		tick();
		render();
	}, 1000/FPS);
}


$(document).ready( () => {
	assetLoad(ImageSrc,Img).then( start );
});


</script>

</head>
<body>
	<div>
		<canvas id="canvas" width="800" height="800"></canvas>
	</div>
</body>
</html>
